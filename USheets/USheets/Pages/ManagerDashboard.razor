@page "/manager-dashboard"
@using USheets.Models
@using Microsoft.AspNetCore.Authorization

@attribute [Authorize(Roles = "Manager")]

<div class="page-header">
    <h3>Manager Dashboard</h3>
    <p>Pending Timesheet Approvals</p>
</div>

@if (isLoading)
{
    <p class="loading-message"><em>Loading timesheets...</em></p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}
else if (pendingTimesheets == null || !pendingTimesheets.Any())
{
    <p class="no-data-message"><em>No timesheets are currently pending approval.</em></p>
}
else
{
    <div class="table-responsive-container">
        <table class="timesheet-table">
            <thead>
                <tr>
                    <th>Employee</th>
                <th>Week Start Date</th>
                <th>Total Hours</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var timesheet in pendingTimesheets)
            {
                <tr>
                    <td>@timesheet.UserId</td> @* Placeholder - needs IUserService integration *@
                    <td>@timesheet.Date.ToShortDateString()</td>
                    <td>@timesheet.TotalHours</td>
                    <td>@timesheet.Status</td>
                    <td>
                        @if (timesheet.Status == TimesheetStatus.Submitted)
                        {
                            <button class="btn btn-success btn-sm" @onclick="() => ApproveTimesheetClicked(timesheet.Id)">Approve</button>
                            <button class="btn btn-danger btn-sm" @onclick="() => RejectTimesheetClicked(timesheet.Id)">Reject</button>
                        }
                    </td>
                </tr>
                @if (timesheet.Status == TimesheetStatus.Rejected && !string.IsNullOrWhiteSpace(timesheet.RejectionReason))
                {
                    <tr class="table-warning">
                        <td colspan="5"><em>Rejection Reason: @timesheet.RejectionReason</em></td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@if (showRejectionModal)
{
    <div class="modal" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Timesheet</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="() => CloseRejectionModal()"></button>
                </div>
                <div class="modal-body">
                    <label for="rejectionReason" class="form-label">Reason for rejection:</label>
                    <textarea id="rejectionReason" class="form-control" @bind="rejectionInput" @bind:event="oninput" rows="3" placeholder="Enter reason..."></textarea>
                    @if (!string.IsNullOrWhiteSpace(rejectionModalErrorMessage))
                    {
                        <div class="text-danger mt-2">@rejectionModalErrorMessage</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => CloseRejectionModal()">Cancel</button> <!-- Assuming btn-secondary is now gray -->
                    <button type="button" class="btn btn-danger" @onclick="() => ConfirmRejectTimesheet()">Confirm Reject</button> <!-- Assuming btn-danger is red -->
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}
